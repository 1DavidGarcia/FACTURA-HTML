<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKY-APP-COUNTER: Presupuesto y Días</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- EmailJS es necesario para el envío de correo OTP real -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .app-container { max-width: 420px; margin: 0 auto; min-height: 100vh; background-color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .chat-window { height: 300px; overflow-y: auto; padding: 1rem; background-color: #e2e8f0; border-radius: 0.5rem; }
        .message { margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; border-radius: 1rem; max-width: 80%; }
        .user-msg { background-color: #3b82f6; color: white; margin-left: auto; border-bottom-right-radius: 0; }
        .ai-msg { background-color: #10b981; color: white; border-bottom-left-radius: 0; }
        .tab-button.active { border-bottom: 3px solid #3b82f6; font-weight: 700; color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100">

<div id="app" class="app-container flex flex-col">
    <!-- Header -->
    <header class="bg-blue-600 p-4 text-white text-center shadow-lg rounded-b-lg flex justify-between items-center">
        <h1 class="text-xl font-bold">SKY-APP-COUNTER</h1>
        <button id="logout-button" onclick="logout()" class="text-sm bg-red-500 hover:bg-red-700 px-3 py-1 rounded-full shadow-md" style="display: none;">
            Salir
        </button>
    </header>

    <!-- 1. OTP/Login Screen (PANTALLA DE AUTENTICACIÓN) -->
    <div id="auth-screen" class="p-6 space-y-4 flex flex-col justify-center flex-grow">
        <h2 class="text-2xl font-semibold text-gray-800 text-center">Acceso OTP</h2>
        <div id="message-box" class="text-sm p-3 rounded-lg text-center hidden"></div>

        <input type="email" id="auth-email" placeholder="Ingresa tu Email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        
        <button id="send-otp-button" onclick="sendOtpReal()" class="w-full bg-indigo-500 text-white p-3 rounded-lg font-semibold hover:bg-indigo-600 transition duration-150">
            Enviar Código OTP (Real)
        </button>

        <input type="text" id="auth-otp" placeholder="Ingresa el Código OTP" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-4" style="display: none;">
        
        <button id="verify-otp-button" onclick="verifyOtp()" class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition duration-150" style="display: none;">
            Verificar y Entrar
        </button>
        <p class="text-xs text-gray-500 text-center mt-3 font-semibold text-green-700">¡EmailJS configurado! Intenta el envío real.</p>
    </div>

    <!-- 2. Main Application (PANTALLA PRINCIPAL CON PESTAÑAS) -->
    <div id="main-app" class="flex-grow flex flex-col" style="display: none;">
        
        <!-- Tabs (Navegación Multi-Pantalla) -->
        <div class="flex border-b border-gray-200">
            <button id="tab-calc" class="tab-button active flex-1 p-3 text-sm transition" onclick="showView('calc')">
                Contador & Presupuesto
            </button>
            <button id="tab-chat" class="tab-button flex-1 p-3 text-sm transition" onclick="showView('chat')">
                Asesor IA
            </button>
        </div>

        <div class="p-4 flex-grow space-y-4 overflow-y-auto">
            
            <!-- VIEW 2.1: Date Counter & Calculator -->
            <div id="calc-view">
                <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">1. Presupuesto Rápido</h3>
                    
                    <label for="start-date" class="block text-sm font-medium text-gray-700">Fecha de Inicio</label>
                    <input type="date" id="start-date" class="w-full p-3 border border-gray-300 rounded-lg mt-1">
                    
                    <label for="end-date" class="block text-sm font-medium text-gray-700 mt-3">Fecha de Fin</label>
                    <input type="date" id="end-date" class="w-full p-3 border border-gray-300 rounded-lg mt-1">

                    <label for="daily-price" class="block text-sm font-medium text-gray-700 mt-3">Precio Diario (USD)</label>
                    <input type="number" id="daily-price" value="45" class="w-full p-3 border border-gray-300 rounded-lg mt-1">

                    <button onclick="calculateBudget()" class="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 mt-4 transition duration-150">
                        Calcular Presupuesto
                    </button>

                    <div id="budget-result" class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                        <p class="font-medium text-blue-800">Resultado:</p>
                        <p id="days-output" class="text-sm text-gray-700"></p>
                        <p id="cost-output" class="text-lg font-bold text-blue-900"></p>
                    </div>
                </div>
            </div>

            <!-- VIEW 2.2: Gemini AI Chatbot -->
            <div id="chat-view" style="display: none;">
                <div class="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">2. Chatbot Asesor Gemini</h3>
                    
                    <div id="chat-window" class="chat-window mb-3">
                        <div class="message ai-msg">
                            Hola! Soy el Asesor Gemini de SKY-APP-COUNTER. Pregúntame sobre tu cotización.
                        </div>
                    </div>

                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Pregunta sobre tu cotización..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <button onclick="handleChat()" class="bg-indigo-500 text-white p-3 rounded-lg font-semibold hover:bg-indigo-600 transition duration-150">
                            Enviar
                        </button>
                    </div>
                    <p id="chat-loading" class="text-center text-sm text-gray-500 mt-2" style="display: none;">Cargando respuesta de Gemini...</p>
                </div>
            </div>

        </div> <!-- End of p-4 flex-grow -->
    </div> <!-- End of main-app -->
</div>

<script>
    const API_KEY = ""; // La clave de Gemini se suministra automáticamente.
    
    // --- CONFIGURACIÓN DE EMAILJS (CLAVES CORREGIDAS) ---
    // Clave Pública (CONFIRMADA EN TU IMAGEN)
    const EMAILJS_PUBLIC_KEY = 'Olk6lWLWFW1mPDPyd'; 
    // Service ID
    const EMAILJS_SERVICE_ID = 'service_0k29106'; 
    // Template ID (¡CORREGIDO con el ID de tu imagen!)
    const EMAILJS_TEMPLATE_ID = 'template_tsrikv8'; 
    // ------------------------------------------------------------------

    let authEmail = '';
    let currentOtp = '';

    // --- UTILITIES ---

    function showMessage(message, type = 'info') {
        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        msgBox.className = `text-sm p-3 rounded-lg text-center mt-3 ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
        msgBox.style.display = 'block';
    }

    function generateRandomOtp() {
        return Math.floor(100000 + Math.random() * 900000).toString(); // Genera un código de 6 dígitos
    }
    
    // --- MANEJO DE VISTAS MULTI-PANTALLA (Tabs) ---
    function showView(viewId) {
        document.getElementById('calc-view').style.display = 'none';
        document.getElementById('chat-view').style.display = 'none';

        document.getElementById(`${viewId}-view`).style.display = 'block';

        // Actualizar el estado activo de las pestañas
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`tab-${viewId}`).classList.add('active');
    }

    function logout() {
        // Reinicia la interfaz al modo de autenticación
        document.getElementById('auth-screen').style.display = 'flex';
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('logout-button').style.display = 'none';
        
        // Limpia el estado de autenticación para un nuevo intento
        document.getElementById('auth-email').value = '';
        document.getElementById('auth-email').disabled = false;
        document.getElementById('send-otp-button').style.display = 'block';
        document.getElementById('auth-otp').value = '';
        document.getElementById('auth-otp').style.display = 'none';
        document.getElementById('verify-otp-button').style.display = 'none';
        showMessage("Sesión cerrada. Ingrese su email para continuar.", 'info');
    }


    // --- AUTHENTICATION FLOW (OTP REAL CORREGIDO) ---

    async function sendOtpReal() {
        // Validar que el campo no esté vacío y tenga formato básico de email.
        authEmail = document.getElementById('auth-email').value;

        if (!authEmail) {
            showMessage("Por favor, ingresa tu email para continuar.", 'error');
            return; // Detiene la ejecución si está vacío
        }
        
        if (!authEmail.includes('@') || !authEmail.includes('.')) {
            showMessage("Por favor, ingresa un formato de email válido.", 'error');
            return; // Detiene la ejecución si el formato es inválido
        }

        currentOtp = generateRandomOtp();
        
        const sendButton = document.getElementById('send-otp-button');
        sendButton.textContent = 'Enviando Código...';
        sendButton.disabled = true;

        // --- CORRECCIÓN CRÍTICA DE VARIABLES (DEBE COINCIDIR CON TU PLANTILLA) ---
        const templateParams = {
            // Variables de la plantilla: 'passcode' (para el código) y 'email' (para el destinatario)
            passcode: currentOtp,
            email: authEmail, // Corresponde al {{email}} de la plantilla
            app_name: "SKY-APP-COUNTER"
        };
        // -------------------------------------------------------------------------
        
        try {
            // Inicializa EmailJS (USA LA CLAVE PÚBLICA CORREGIDA)
            emailjs.init(EMAILJS_PUBLIC_KEY);

            const response = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);

            if (response.status !== 200) {
                 // Si el estado no es 200, lanza un error para caer en el catch.
                 throw new Error(`Error en el servidor de EmailJS: ${response.status} - ${response.text || 'Respuesta desconocida'}`);
            }

            // Transición de UI exitosa
            document.getElementById('auth-email').disabled = true;
            document.getElementById('send-otp-button').style.display = 'none';
            document.getElementById('auth-otp').style.display = 'block';
            document.getElementById('verify-otp-button').style.display = 'block';
            
            showMessage(`¡Código enviado! Revisa tu email: ${authEmail}.`, 'info');

        } catch (error) {
            // --- MANEJO DE ERRORES EXPLÍCITO Y FIX DE EMERGENCIA ---
            console.error("Error al enviar el OTP:", error);
            console.warn(`[CÓDIGO GENERADO POR FALLO]: ${currentOtp}. ÚSALO PARA ACCEDER.`);

            let errorMessage = `ERROR DE CONFIGURACIÓN. Usa: ${currentOtp} (en consola) para entrar.`;
            
            // Si el error es 400 (fallo de configuración de ID o clave)
            if (String(error.message).includes('400')) {
                 errorMessage = `ERROR: Verifica si el ID de Plantilla (${EMAILJS_TEMPLATE_ID}) y el ID de Servicio (${EMAILJS_SERVICE_ID}) son correctos en EmailJS. También verifica la clave pública. Usa el código ${currentOtp} para entrar.`;
            } else if (String(error.message).includes('network')) {
                 errorMessage = `ERROR DE RED. Autoriza tu dominio local (127.0.0.1) en EmailJS. Usa el código ${currentOtp} para entrar.`;
            } else {
                // Para cualquier otro error desconocido
                errorMessage = `FALLO DESCONOCIDO (${error.message || 'Sin detalles'}). Código de emergencia: ${currentOtp}.`;
            }

            showMessage(errorMessage, 'error');

            // Fallback para permitir el acceso con el código generado (Simulación por fallo)
            document.getElementById('auth-email').disabled = true;
            document.getElementById('send-otp-button').style.display = 'none';
            document.getElementById('auth-otp').style.display = 'block';
            document.getElementById('verify-otp-button').style.display = 'block';

        } finally {
            sendButton.textContent = 'Enviar Código OTP (Real)';
            sendButton.disabled = false;
        }
    }

    function verifyOtp() {
        const enteredOtp = document.getElementById('auth-otp').value.trim();
        
        if (enteredOtp === currentOtp && currentOtp !== '') {
            showMessage("Verificación exitosa. Accediendo...", 'success');
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex'; // Muestra la aplicación principal
            document.getElementById('logout-button').style.display = 'block'; // Muestra el botón de salir
            showView('calc'); // Muestra la vista de calculadora por defecto
        } else {
            showMessage("Código OTP incorrecto. Intenta de nuevo.", 'error');
        }
    }

    // --- FEATURE 1: DATE COUNTER & CALCULATOR ---

    function calculateBudget() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const dailyPrice = parseFloat(document.getElementById('daily-price').value);

        if (!startDate || !endDate || isNaN(dailyPrice) || dailyPrice <= 0) {
            showMessage("Por favor, ingresa fechas válidas y un precio diario.", 'error');
            return;
        }

        const start = new Date(startDate);
        const end = new Date(endDate);

        if (start >= end) {
            showMessage("La fecha de fin debe ser posterior a la fecha de inicio.", 'error');
            return;
        }

        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

        const totalCost = diffDays * dailyPrice;

        document.getElementById('days-output').textContent = `Total de Días de Alquiler: ${diffDays} días`;
        document.getElementById('cost-output').textContent = `Presupuesto Estimado: $${totalCost.toFixed(2)}`;
        document.getElementById('message-box').style.display = 'none';
    }


    // --- FEATURE 2: GEMINI AI CHATBOT ---

    function appendMessage(sender, text) {
        const chatWindow = document.getElementById('chat-window');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender === 'user' ? 'user-msg' : 'ai-msg'}`;
        msgDiv.textContent = text;
        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight; 
    }

    async function handleChat() {
        const inputElement = document.getElementById('chat-input');
        const userQuery = inputElement.value.trim();

        if (!userQuery) return;

        appendMessage('user', userQuery);
        inputElement.value = '';
        document.getElementById('chat-loading').style.display = 'block';

        // --- GEMINI API CALL ---
        const systemPrompt = `
            Actúa como el Asesor de Presupuesto e Inventario de SKY-APP-COUNTER, una rentadora de vehículos.
            Tu única función es ayudar al usuario a cotizar y analizar su alquiler.
            Si el usuario pregunta por fechas, días o presupuesto, tu respuesta DEBE incluir:
            1. El cálculo de días y costo (si proporciona los datos).
            2. Recomendaciones basadas en el número de días.
            3. Sé conciso y profesional.
        `;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

        const payload = {
            contents: [{ 
                parts: [{ text: userQuery }] 
            }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Lo siento, no pude obtener una respuesta.";
            
            appendMessage('ai', text);

        } catch (error) {
            console.error("Gemini API Error:", error);
            appendMessage('ai', `Error del sistema IA: No se pudo conectar con Gemini. Detalles: ${error.message}`);
        } finally {
            document.getElementById('chat-loading').style.display = 'none';
        }
    }
    
    // Initial setup on load
    window.onload = () => {
        // Configuración inicial de fechas y vista por defecto
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        document.getElementById('start-date').valueAsDate = today;
        document.getElementById('end-date').valueAsDate = nextWeek;
        
        // La vista de calculadora se establece al iniciar sesión
        document.getElementById('tab-calc').classList.add('active'); 
    };
</script>

</body>
</html>
